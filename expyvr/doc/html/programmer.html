<!doctype html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="main.css" />
	<title>ExpyVR Programmer's Guide</title>
</head>

<body>
<div id="container">
<iframe class="headerIframe" src="header.html"></iframe>

<div id="center">
<h1>Programmer's Guide</h1>
<h2 id="contents">Contents</h2>
<ul>
<li>
	<a href="#overview">Overview</a>
	<ul>
	<li><a href="#bigPicture">Big Picture</a></li>
	</ul>
</li>
<li>
	<a href="#newModules">Creating New Modules</a>
	<ul>
	<li><a href="#configuration">Module Configuration</a></li>
	<li><a href="#helpers">BasicModule Instance Variables and Helper Methods</a></li>
	<li><a href="#methodsToExtend">Methods to Extend</a></li>
	<li><a href="#icon">Module Icon</a></li>
	<li><a href="#example">Minimal Example</a></li>
	</ul>
</li>
<li><a href="#editingDocumentation">Editing the Documentation</a></li>
</ul>


<h2 id="overview">Overview</h2>
<i>ExpyVR</i> is a framework written in Python developed by the Laboratory of Cognitive Neuroscience at EPFL. It is made for designing and running computerised experiments, most notably experiments in virtual-reality.<br />
The ExpyVR framework is still in development. This guide might therefore not always be up-to-date.
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h3 id="bigPicture">Big Picture</h3>
<div style="text-align:center"><img src="images/schema.png" alt="Schema of ExpyVR framework"/></div>
Every of the colourful boxes above represent a Python package. The core of the framework is made up of a controller that takes an instance file generated by the Experiment Designer and prepares the display(s) and the logger. This is needed in all the experiments. Every module knows about the controller and all information exchanged between modules flows through the controller. The blue boxes above represent components that can be used within the experiment. The core is clearly separated from the other modules and there is a very simply interface. This means that a programmer does not need to understand how everything works but can simply write a new module that adheres to the interface.
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h2 id="newModules">Creating New Modules</h2>
<p>To create a new module that can be inserted from the Experiment Designer GUI and used in the experiment you have to create a new class called <i>ModuleMain</i> that extends from <i>BasicModule</i> or one of the other classes in <i>/src/abstract/AbstractClasses.py</i>. If your module should somehow be displayed in the virtual scene, you should extend from <i>DrawableModule</i>. This class will be instantiated during runtime of the experiment and will do whatever it is that this module does. Static dictionaries are also used to determine what parameters can be configured by the user in the Experiment Designer.</p>
<p>The other thing that you have to do to get your module to be available in the Experiment Designer is to add it to  <i>/expbuilder/app/components/components.xml</i>.</p>
<p>Please look at existing modules and especially at the example below to see what conventions are in place and try to follow them.</p>
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h3 id="configuration">Module Configuration</h3>
Every module is configured through two dictionaries that are passed to the __init__ method. The <i>initConf</i> is used for parameters that are set only once for the module and left unchanged during the whole experiment. The <i>runConf</i> is for parameters that can change every time the component is activated. To define what parameters are needed by your module, you have to overwrite the following three static class members:
<ul>
<li><b>defaultInitConf:</b> A dictionary mapping the names of the init parameters to their default value. Every module hast to have at least the parameter <i>name</i>.</li>
<li><b>defaultRunConf:</b> A dictionary mapping the names of the run parameters to their default value. Can be empty.</li>
<li><b>confDescription:</b> A list that describes both the init and run config parameters. The order in which the parameters appear in this list, will be the order they are shown in the Experiment Designer. Every list element is a 3- or 4-tuple with the following elements:
	<ul>
	<li><b>Name:</b> The same name as in the defaultInit/RunConf dictionary.</li>
	<li><b>Type:</b> Type of this parameters: int, float, bool (will be displayed as a checkbox), str, code (for more complex types such as tuples and dicts).</li>
	<li><b>Description:</b> Description of this parameter that will be shown to the user. If the description ends with a *, the parameter will be shown in bold indicating that it can be accessed by scripts.</li>
	<li><b>Allowed values:</b> Optional list of allowed values for this parameter. If present the parameters will be displayed as a dropdown box.</li>
	</ul>
</li>
</ul>
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h3 id="helpers">BasicModule Instance Variables and Helper Methods</h3>
The <i>BasicModule</i> class has a few instance variables that can be used by your module. It is best to only read these variables and let the BasicModule take care of updating them to appropriate values. To make sure this can always be done, you need to call the parent method whenever you extend a method. The instance variables are:
<ul>
<li><b>initConf:</b> Complete dictionary of initConf values.</li>
<li><b>runConfs:</b> A dictionary of dictionaries. All the run configs that will be used in the experiment indexed by their name. It is useful to have all of the runConfs already at initialisation time if one for example wants to load all images that will later be displayed at the beginning.</li>
<li><b>activeConf:</b> The dictionary of the currently active run config. This is how the current run config should be accessed in most cases. This is the same as <i>self.runConfs[self.activeConfName]</i>.</li>
<li><b>activeConfName:</b> The name of the currently active run config.</li>
<li><b>controller:</b> A reference to the <i>MainControl</i> object that is managing the experiment.</li>
<li><b>started:</b> Boolean value whether the component is currently started or stopped.</li>
</ul>
Additionally there are a couple of helper methods at your disposal:
<ul>
<li><b>log:</b> Logs something to the logger. The logger takes care to keep track of which component logs what. The argument to this method can be a simple string or any other object that can be converted to a string.</li>
<li><b>getName:</b> Returns the name of this component. This is not the name of the module itself, but the name the user gave the instance in the Experiment Builder.</li>
<li><b>getStartingTimes:</b> Returns the times when the module was started: [absoluteTime, experimentTime, displayTime].</li>
</ul>
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h3 id="methodsToExtend">Methods to Extend</h3>
The following methods should most likely be extended by your module. Remember, ff you overwrite a method make sure you call the parent method, even if it is empty at the moment because this might change in the future. The methods that can be extended are:
<ul>
<li><b>__init__:</b> Initialises the component. It is crucial to call the parent method first so that the above mentioned instance variables can be initialised. You should not access the parameters of this method directly, but instead rely on the instance variables described before.</li>
<li><b>start:</b> Called whenever the component is started/activated.</li>
<li><b>stop:</b> Called whenever the component is stopped/deactivated.</li>
<li><b>cleanup:</b> Called when the component is destroyed. Make sure you clean up all the open files, connections, etc. here.</li>
<li><b>draw:</b> Only if you extend from <i>DrawableModule</i>. Called on every frame while the component is visible. Should contain all the OpenGL calls to draw whatever this module needs to display.</li>
</ul>
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h3 id="icon">Module Icon</h3>
To get your component to be shown with a cool icon in the Experiment Builder, place a png file called <i>yourmodulename.png</i> (lower-case, no separation between words) in <i>/expbuilder/app/components/resources</i>.
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h3 id="example">Minimal Example</h3>
Here is the code for the class that is necessary to create a minimal module that is displayed on the screen. The module simply draws a dot at the origin that changes colour depending on whether it is activated or not. It has one parameters called <i>colour</i> that is used to determine the colour when active. This module is also in the examples in the SVN and can be copied into the main source code to see how it works. Copy the whole stub folder into the <i>/src/</i> folder and add the following line to <i>/expbuilder/app/components/components.xml</i>:
<pre>&lt;<span style="color:blue;">Component</span> <span style="color: Red;">type</span>="Stub" <span style="color: Red;">importPath</span>="stubs.stubComponent" /&gt;</pre>

<h4>stubComponent.py</h4>
<pre><span style="color: green;">"""
Stub module that shows the interface for creating new components.

@author: Tobias Leugger
@since: June 2010
"""</span>

<span style="color: blue;">from</span> pyglet.gl <span style="color: blue;">import</span> *


<span style="color: blue;">from</span> scene.scene <span style="color: blue;">import</span> SceneElement
<span style="color: blue;">from</span> abstract.AbstractClasses <span style="color: blue;">import</span> DrawableModule

<span style="color: blue;">class</span> <b>ModuleMain</b>(SceneElement, DrawableModule):
    <span style="color: green;">"""
    Main class of this module
    """</span>
    defaultInitConf = {
        <span style="color: green;">'</span><span style="color: green;">name</span><span style="color: green;">'</span>: <span style="color: green;">'</span><span style="color: green;">stubby</span><span style="color: green;">'</span>            <span style="color: #008000;">#</span><span style="color: #008000;"> any string  </span><span style="color: #008000;">
</span>    }
    
    defaultRunConf = {   
        <span style="color: green;">'</span><span style="color: green;">colour</span><span style="color: green;">'</span>: <span style="color: green;">'</span><span style="color: green;">[1., 0., 0.]</span><span style="color: green;">'</span>    <span style="color: #008000;">#</span><span style="color: #008000;"> the colour of the point to draw</span><span style="color: #008000;">
</span>    }
    
    confDescription = [
        (<span style="color: green;">'</span><span style="color: green;">name</span><span style="color: green;">'</span>, <span style="color: green;">'</span><span style="color: green;">str</span><span style="color: green;">'</span>, <span style="color: green;">"</span><span style="color: green;">Name of this component</span><span style="color: green;">"</span>),
        (<span style="color: green;">'</span><span style="color: green;">colour</span><span style="color: green;">'</span>, <span style="color: green;">'</span><span style="color: green;">str</span><span style="color: green;">'</span>, <span style="color: green;">"</span><span style="color: green;">Colour when active</span><span style="color: green;">"</span>),
    ]
    
    <span style="color: blue;">def</span> <b>__init__</b>(self, controller, initConfig=None, runConfigs=None):
        SceneElement.__init__(self)
        DrawableModule.__init__(self, controller, initConfig, runConfigs)
        
        self.active = False
            
    <span style="color: blue;">def</span> <b>draw</b>(self, window_width, window_height, eye=-1):
        <span style="color: green;">"""
        Draws a dot at the origin, the colour depends on whether the component is active or not
        """</span>
        DrawableModule.draw(self, window_width, window_height, eye)
        colour = eval(self.activeConf[<span style="color: green;">'</span><span style="color: green;">colour</span><span style="color: green;">'</span>])
        <span style="color: blue;">if</span> self.active:
            glColor3f(colour[0], colour[1], colour[2])
        <span style="color: blue;">else</span>:
            glColor3f(1., 1., 1.)
        glPointSize(20)
        glBegin(GL_POINTS)
        glVertex3f(0, 0, 0)
        glEnd()
        
    <span style="color: blue;">def</span> <b>start</b>(self, dt=0, duration=-1, configName=None):
        <span style="color: green;">"""
        Activate this module
        """</span>
        DrawableModule.start(self, dt, configName)
        
        <span style="color: #008000;">#</span><span style="color: #008000;"> activate</span><span style="color: #008000;">
</span>        self.active = True
        
    <span style="color: blue;">def</span> <b>stop</b>(self, dt=0):
        DrawableModule.stop(self, dt)
        
        <span style="color: #008000;">#</span><span style="color: #008000;"> stop</span><span style="color: #008000;">
</span>        self.active = False
            
</pre>
<p class="toContents"><a href="#contents">Back to contents</a></p>

<h2 id="editingDocumentation">Editing the Documentation</h2>
As you might have noticed, the documentation consists of simple HTML files. Take your HTML editor of choice and keep the documentation up-to-date! To show that you did, don't forget to add your name and to update the <i>Last update</i> in the footer of the page you edited. If you don't have an editor of choice, you might want to try <a href="http://www.seamonkey-project.org/">SeaMonkey</a> that contains a decent what-you-see-is-what-you-get HTML editor.
<p class="toContents"><a href="#contents">Back to contents</a></p>


</div>

<div id="bottom">
Last update: 8.11.2011&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;Author: Tobias Leugger</div>
</div>
</body>
</html>

